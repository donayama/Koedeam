# Voice 実機テスト観点メモ（Block 0）

## 目的

Koedeam の音声入力改善（Block 1 以降）に先立ち、iOS Safari / Windows Chrome を中心に、再現しやすい不具合観点と確認手順を整理する。

## 対象環境

- iOS Safari（最新安定版 + 1 世代前）
- Windows Chrome（最新安定版）
- 可能なら Android Chrome（参考比較）

## テスト前提

- HTTPS 配信または localhost（マイク権限が有効なコンテキスト）
- `Main Editor`、`Voice Panel`、`Status Indicator` の表示が確認できること
- 端末時刻が正常であること（ログ時刻比較のため）

## 実機テスト観点（優先順）

### 1) 権限・初回起動

- マイク権限の初回許可 / 拒否が想定どおり遷移する
- 拒否後の再試行導線（ブラウザ設定で再許可）が案内できる
- iOS Safari で権限ダイアログ後に UI が固まらない

### 2) 復帰・中断耐性

- 画面ロック解除後に音声入力を再開できる
- バックグラウンド遷移（アプリ切替）後に UI 状態が破綻しない
- 着信・通知割り込み後に `Status Indicator` が実状態へ戻る

### 3) no-speech / network / aborted などエラー処理

- `no-speech` を異常終了扱いせず復帰フローへ入る
- 一時的な通信不安定時に再開待ち状態へ遷移できる
- 連続エラー時も `Main Editor` が編集不能状態で固まらない

### 4) Bluetooth / 音声ルート変更

- BT マイク接続・切断時に入力停止しても復帰できる
- 音声ルート変更後に意図しない重複開始が起きない
- デバイス切替時の遅延中でも UI が多重操作可能にならない

### 5) selection / カーソル整合

- 音声確定テキストがカーソル位置に挿入される
- 手動選択中に音声確定が来ても selection が破綻しない
- iOS Safari でキーボード開閉後も selectionStart/End が整合する

### 6) `VOICE_LOCKED` と入力抑止

- `VOICE_LOCKED` 中に `beforeinput` / `paste` / `keydown` が抑止される
- 音声停止後に編集可能へ正常復帰する
- `Search Panel` / `Snapshot Panel` 開閉時の背後編集禁止を維持する

## 代表シナリオ（最小セット）

1. 初回許可 → 30 秒発話 → 無音終了 → 自動復帰確認
2. 起動中にアプリ切替 10 秒 → 復帰 → 再開確認
3. 発話中に BT イヤホン切断 → エラー → 再開確認
4. 選択範囲ありで発話確定 → 挿入位置・選択整合確認
5. `VOICE_LOCKED` 中に貼り付け/キー入力 → 抑止確認

## 収集メモ（手動）

- 端末 / OS / ブラウザバージョン
- 発生時刻（ローカル）
- 直前操作（起動・切替・BT接続など）
- UI 表示状態（`Status Indicator` 文言）
- 回復可否（自動 / 手動 / 要再読み込み）

## Block 1 への引き継ぎ

- 音声状態遷移を「権限待ち / 稼働 / 停止 / 再開待ち」でコード化する
- `onend` 再 start とエラー復帰条件を分離し、無限再試行を避ける
- テストでは SpeechRecognition スタブで `onresult/onerror/onend` を再現できる形にする

<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Koedeam Editor</title>
  <meta name="description" content="声で編む、草稿エディタ（ローカル保存・共有）" />

  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="../assets/icon.svg" type="image/svg+xml" />
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <header class="topbar" aria-label="App Header">
    <a class="brand" href="../"><img src="../assets/icon.svg" alt="" class="brand-icon" />Koedeam</a>
    <div id="statusIndicator" class="status-indicator" aria-live="polite">
      <span id="statusPrimary" class="chip">EDIT</span>
      <span id="statusInput" class="chip">VOICE:OFF</span>
      <span id="statusSystem" class="chip">LOCAL</span>
      <span id="statusLayout" class="chip">MOBILE</span>
    </div>
    <div class="top-actions">
      <button id="btnHeaderDocuments" type="button" class="btn-icon header-switch"><span class="icon">🗂</span>文書</button>
      <button id="btnHeaderSnapshot" type="button" class="btn-icon header-switch"><span class="icon">🕒</span>履歴</button>
      <button id="btnMenu" type="button" class="btn-icon"><span class="icon">☰</span>メニュー</button>
    </div>
  </header>

  <div class="layout">
    <main class="main" aria-label="editor area">
      <div class="editor-wrap">
        <div id="caretLine" class="caret-line hidden"></div>
        <div id="caretDot" class="caret-dot hidden"></div>
        <textarea id="editor" placeholder="話して、書いて、整えて、共有。"></textarea>
      </div>
      <div class="status-row">
        <span id="saveStatus">Ready</span>
        <span id="appMessage" aria-live="polite"></span>
      </div>
    </main>

    <aside id="sidebar" class="sidebar" aria-label="sidebar">
      <div class="side-head">
        <strong>サイドバー</strong>
        <button id="btnCloseSidebar" type="button" class="btn-icon"><span class="icon">✕</span>Close</button>
      </div>
      <div class="side-tabs" role="tablist" aria-label="sidebar tabs">
        <button type="button" class="tab-btn" data-tab="templates" aria-controls="panelTemplates">テンプレ</button>
        <button type="button" class="tab-btn" data-tab="history" aria-controls="panelHistory">保存・履歴</button>
      </div>
      <section id="panelTemplates" class="tab-panel" role="tabpanel">
        <div id="sidebarTemplates" class="sidebar-list"></div>
      </section>
      <section id="panelHistory" class="tab-panel">
        <div class="dialog-actions">
          <button id="btnOpenDocuments" type="button">ドキュメント一覧</button>
          <button id="btnSnapshot" type="button">スナップショット保存</button>
          <button id="btnOpenSnapshotPanel" type="button">パネル表示</button>
        </div>
        <label>自動スナップショット（分）
          <select id="autoSnapshotSelect">
            <option value="0">OFF</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="15">15</option>
          </select>
        </label>
        <div id="historyList" class="dialog-list dialog-body"></div>
      </section>
    </aside>
  </div>

  <nav class="bottombar" aria-label="Tool Bar">
    <button id="btnMic" type="button" class="btn-icon toolbar-item" data-tool="mic"><span class="icon">🎤</span>音声入力</button>
    <button id="btnVoiceMode" type="button" class="btn-icon toolbar-item" data-tool="voiceMode"><span class="icon">🎛</span>音声:カーソル</button>
    <button id="btnReplace" type="button" class="btn-icon toolbar-item" data-tool="replace"><span class="icon">🔎</span>検索・置換</button>
    <button id="btnTemplates" type="button" class="btn-icon toolbar-item" data-tool="templates"><span class="icon">📄</span>テンプレ</button>
    <button id="btnHistory" type="button" class="btn-icon toolbar-item" data-tool="history"><span class="icon">🕒</span>保存・履歴</button>
    <button id="btnEditTools" type="button" class="btn-icon toolbar-item" data-tool="edit"><span class="icon">✎</span>編集</button>
    <button id="btnShare" type="button" class="btn-icon toolbar-item" data-tool="share"><span class="icon">⇪</span>共有</button>
    <button id="btnOverflow" type="button" class="btn-icon toolbar-overflow"><span class="icon">…</span>その他</button>
  </nav>

  <div id="menuOverlay" class="menu-overlay hidden" aria-hidden="true">
    <aside id="menuPanel" class="menu-panel" aria-label="menu">
      <div class="menu-head">
        <strong>メニュー</strong>
        <button id="btnCloseMenu" type="button" class="btn-icon"><span class="icon">✕</span>Close</button>
      </div>
      <div class="menu-list">
        <button type="button" class="btn-icon" data-menu="replace"><span class="icon">🔎</span>検索・置換</button>
        <button type="button" class="btn-icon" data-menu="templates"><span class="icon">📄</span>テンプレ</button>
        <button type="button" class="btn-icon" data-menu="documents"><span class="icon">🗂</span>文書一覧</button>
        <button type="button" class="btn-icon" data-menu="history"><span class="icon">🕒</span>保存・履歴</button>
        <div id="overflowMenuItems" class="menu-list overflow-menu-items"></div>
        <button type="button" class="btn-icon" data-menu="sidebar"><span class="icon">▤</span>サイドバー</button>
        <button type="button" class="btn-icon" data-menu="settings"><span class="icon">⚙</span>設定</button>
        <button type="button" class="btn-icon" data-menu="help"><span class="icon">?</span>ヘルプ</button>
      </div>
    </aside>
  </div>

  <dialog id="dlgShare">
    <h2>共有</h2>
    <div class="share-mode">
      <button id="btnShareAll" type="button" data-mode="all">全文</button>
      <button id="btnShareSelection" type="button" data-mode="selection">選択範囲</button>
    </div>
    <div class="dialog-actions wrap shortcut-inline">
      <button id="btnNativeShare" type="button" class="btn-icon"><span class="icon">⇪</span>共有</button>
      <button id="btnCopy" type="button">COPY</button>
      <div id="shareShortcutList" class="shortcut-inline-list"></div>
      <button id="btnOpenSettingsShare" type="button" class="btn-icon"><span class="icon">⚙</span>ショートカット管理へ</button>
    </div>
    <div class="dialog-footer"><button id="btnCloseShare" type="button">Close</button></div>
  </dialog>

  <dialog id="dlgSearch">
    <h2>検索・置換</h2>
    <label>検索語
      <input id="findQuery" type="text" />
    </label>
    <div id="findRecent" class="chip-list"></div>
    <fieldset class="segment">
      <legend>検索オプション</legend>
      <label><input id="optCase" type="checkbox" />大文字/小文字を区別</label>
      <label><input id="optRegex" type="checkbox" />正規表現</label>
    </fieldset>
    <label>置換語
      <input id="replaceQuery" type="text" />
    </label>
    <p id="findStatus">0件</p>
    <div class="dialog-actions wrap">
      <button id="btnFindPrev" type="button">前へ</button>
      <button id="btnFindNext" type="button">次へ</button>
      <button id="btnReplaceOne" type="button">置換</button>
      <button id="btnReplaceNext" type="button">次を置換して次へ</button>
      <button id="btnReplaceAll" type="button">全置換</button>
      <button id="btnReplaceInSelection" type="button">選択範囲のみ全置換</button>
    </div>
    <div class="dialog-footer"><button id="btnCloseSearch" type="button">Close</button></div>
  </dialog>

  <dialog id="dlgDocuments">
    <h2>ドキュメント一覧</h2>
    <div class="dialog-actions">
      <button id="btnNewDoc" type="button">新規ドキュメント</button>
    </div>
    <div id="documentsList" class="dialog-list dialog-body"></div>
    <div class="dialog-footer"><button id="btnCloseDocuments" type="button">Close</button></div>
  </dialog>

  <dialog id="dlgSnapshot">
    <h2>スナップショット</h2>
    <div class="dialog-actions">
      <button id="btnSnapshotSave" type="button">スナップショット保存</button>
    </div>
    <label>自動スナップショット（分）
      <select id="snapshotAutoSnapshotSelect">
        <option value="0">OFF</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="5">5</option>
        <option value="10">10</option>
        <option value="15">15</option>
      </select>
    </label>
    <div id="snapshotHistoryList" class="dialog-list dialog-body"></div>
    <div class="dialog-footer"><button id="btnCloseSnapshot" type="button">Close</button></div>
  </dialog>

  <dialog id="dlgSettings">
    <div class="settings-bar">
      <h2>設定</h2>
      <div class="side-tabs settings-tabs" role="tablist" aria-label="settings tabs">
        <button type="button" class="tab-btn" data-tab="appearance" aria-controls="panelSettingsAppearance">表示</button>
        <button type="button" class="tab-btn" data-tab="templates" aria-controls="panelSettingsTemplates">テンプレート</button>
        <button type="button" class="tab-btn" data-tab="share" aria-controls="panelSettingsShare">共有ショートカット</button>
        <button type="button" class="tab-btn" data-tab="api" aria-controls="panelSettingsApi">その他</button>
        <button id="btnCloseSettings" type="button" class="tab-btn settings-close">Close</button>
      </div>
    </div>
    <section id="panelSettingsAppearance" class="tab-panel settings-section" role="tabpanel">
      <h3>表示</h3>
      <div class="font-row">
        <span class="font-label">サイズ</span>
        <input id="fontSizeRange" type="range" min="12" max="32" step="1" />
        <span id="fontSizeValue" class="hint"></span>
      </div>
      <fieldset class="segment">
        <legend>フォントフェイス</legend>
        <div class="font-face-row">
          <label class="font-chip font-sans-jp">
            <input type="radio" name="fontFace" value="sans-jp" />
            <span>ゴシック</span>
          </label>
          <label class="font-chip font-serif-jp">
            <input type="radio" name="fontFace" value="serif-jp" />
            <span>明朝</span>
          </label>
          <label class="font-chip font-mono">
            <input type="radio" name="fontFace" value="mono" />
            <span>等幅</span>
          </label>
        </div>
      </fieldset>
      <fieldset class="segment">
        <legend>編集パネル配置</legend>
        <div class="option-row">
          <label class="option-chip"><input type="radio" name="editPanelPos" value="bottom" />下</label>
          <label class="option-chip"><input type="radio" name="editPanelPos" value="top" />上</label>
          <label class="option-chip"><input type="radio" name="editPanelPos" value="left" />左</label>
          <label class="option-chip"><input type="radio" name="editPanelPos" value="right" />右</label>
        </div>
      </fieldset>
      <fieldset class="segment">
        <legend>音声挿入モード</legend>
        <div class="option-row">
          <label class="option-chip"><input type="radio" name="voiceMode" value="off" />OFF</label>
          <label class="option-chip"><input type="radio" name="voiceMode" value="append" />末尾</label>
          <label class="option-chip"><input type="radio" name="voiceMode" value="cursor" />カーソル</label>
        </div>
      </fieldset>
      <fieldset class="segment">
        <legend>ツールバー表示</legend>
        <div id="toolbarOrderList" class="dialog-list dialog-body"></div>
      </fieldset>
    </section>
    <section id="panelSettingsTemplates" class="tab-panel settings-section">
      <h3>テンプレ</h3>
      <div id="templateList" class="dialog-list dialog-body"></div>
      <form id="templateForm" class="template-form">
        <input id="templateId" type="hidden" />
        <label>名前<input id="templateName" type="text" maxlength="60" required /></label>
        <label>本文<textarea id="templateText" rows="5" required></textarea></label>
        <div class="dialog-actions">
          <button id="btnTemplateSave" type="submit">保存</button>
          <button id="btnTemplateReset" type="button">クリア</button>
        </div>
      </form>
    </section>
    <section id="panelSettingsShare" class="tab-panel settings-section">
      <div id="settingsShareList" class="dialog-list dialog-body"></div>
      <form id="shareShortcutForm" class="template-form">
        <input id="shortcutId" type="hidden" />
        <label>名前<input id="shortcutName" type="text" required /></label>
        <label>URLテンプレート<input id="shortcutUrl" type="text" placeholder="mailto:?subject={title}&body={text}" required /></label>
        <p class="hint">凡例：{text} = 本文/選択、{title} = 先頭行、{prompt} = {text} と同義</p>
        <div class="dialog-actions">
          <button type="submit">保存</button>
          <button id="btnShortcutReset" type="button">クリア</button>
        </div>
      </form>
    </section>
    <section id="panelSettingsApi" class="tab-panel settings-section">
      <h3>APIキー（端末内保存）</h3>
      <label>OpenAI API Key
        <input id="apiKeyOpenAI" type="password" placeholder="sk-..." />
      </label>
      <label>Other API Key
        <input id="apiKeyOther" type="password" placeholder="任意" />
      </label>
      <p class="hint">キーは端末内のみ保存され、外部送信は行いません。</p>
      <div class="settings-section">
        <h3>初期化</h3>
        <button id="btnResetApp" type="button">設定と下書きを初期化</button>
        <p class="hint">この操作は取り消せません。localStorage内のデータを削除します。</p>
      </div>
      <div class="settings-section">
        <h3>強制リロード</h3>
        <button id="btnForceReload" type="button">強制リロード</button>
        <p class="hint">Service Worker とキャッシュを解除して再読み込みします。</p>
      </div>
    </section>
  </dialog>

  <section id="editToolsPanel" class="edit-tools" aria-label="edit tools">
    <div class="edit-tools-head">
      <strong>編集補助</strong>
      <span class="hint">リアルタイム操作用</span>
    </div>
    <div class="edit-tools-block">
      <div class="edit-group cursor-group">
        <div class="edit-group-head">カーソル</div>
        <div class="edit-grid">
          <div class="edit-row row-1">
            <button id="btnSelectParaPrev" type="button" class="nav-wide"><span class="icon">⤒</span>段落</button>
            <button id="btnMoveUp" type="button" class="nav-pad"><span class="icon">▲</span></button>
            <button id="btnDocStart" type="button"><span class="icon">⏮</span>文頭</button>
          </div>
          <div class="edit-row row-2">
            <button id="btnLineStart" type="button" class="nav-wide icon-only" aria-label="行頭"><span class="icon">|◀</span></button>
            <button id="btnMoveLeft" type="button" class="nav-pad"><span class="icon">◀</span></button>
            <button id="btnMoveRight" type="button" class="nav-pad"><span class="icon">▶</span></button>
            <button id="btnLineEnd" type="button" class="nav-wide icon-only" aria-label="行末"><span class="icon">▶|</span></button>
          </div>
          <div class="edit-row row-3">
            <button id="btnSelectParaNext" type="button" class="nav-wide"><span class="icon">⤓</span>段落</button>
            <button id="btnMoveDown" type="button" class="nav-pad"><span class="icon">▼</span></button>
            <button id="btnDocEnd" type="button"><span class="icon">⏭</span>文末</button>
          </div>
        </div>
      </div>
      <div class="edit-group toolbar-group">
        <div class="edit-group-head">編集</div>
        <div class="edit-toolbar-grid">
          <div class="edit-toolbar-main">
            <button id="btnCopySel" type="button" class="icon-only" aria-label="Copy"><span class="icon">⎘</span></button>
            <button id="btnCutSel" type="button" class="icon-only" aria-label="Cut"><span class="icon">✂</span></button>
            <button id="btnPasteSel" type="button" class="icon-only" aria-label="Paste"><span class="icon">⎘</span></button>
            <button id="btnDelete" type="button" class="icon-only" aria-label="Delete"><span class="icon">⌦</span></button>
            <button id="btnBackspace" type="button" class="icon-only" aria-label="Backspace"><span class="icon">⌫</span></button>
            <button id="btnComma" type="button">、</button>
            <button id="btnPeriod" type="button">。</button>
            <button id="btnNewline" type="button" class="icon-only" aria-label="改行"><span class="icon">↵</span></button>
            <button id="btnPuncMode" type="button" class="chip">JP</button>
          </div>
          <div class="line-delete-row">
            <button id="btnDeleteToLineStart" type="button" class="line-delete"><span class="icon">⌫|</span>行頭まで削除</button>
            <button id="btnDeleteToLineEnd" type="button" class="line-delete"><span class="icon">|⌦</span>行末まで削除</button>
          </div>
        </div>
      </div>
      <div class="edit-group range-group">
        <div class="edit-group-head">範囲選択</div>
        <div class="edit-tools-row">
          <button id="btnSelectLine" type="button"><span class="icon">▭</span>行</button>
          <button id="btnSelectPara" type="button"><span class="icon">≡</span>段落</button>
          <button id="btnSelectAll" type="button"><span class="icon">▣</span>全文</button>
        </div>
        <div class="edit-tools-row">
          <button id="btnExpandUp" type="button"><span class="icon">⇑</span>上に拡張</button>
          <button id="btnExpandDown" type="button"><span class="icon">⇓</span>下に拡張</button>
          <button id="btnShrinkUp" type="button"><span class="icon">⇠</span>上を縮小</button>
          <button id="btnShrinkDown" type="button"><span class="icon">⇢</span>下を縮小</button>
        </div>
      </div>
    </div>
  </section>

  <dialog id="dlgHelp">
    <h2>Koedeam Help</h2>
    <p>本文は端末内（localStorage）に保存されます。サーバー送信は行いません。</p>
    <p>Web Speech API はブラウザ実装により外部認識サービスが使われる可能性があります。機密文面は OS 音声入力の利用も検討してください。</p>
    <p>共有ショートカットのURLスキームは端末・アプリ仕様に依存します。URLパラメータで本文が入らない場合もあるため、必要に応じてURL編集またはコピー共有を利用してください。</p>
    <p id="iosInstallHint" class="hint hidden">iPhone/iPad: 共有メニューから「ホーム画面に追加」でPWAとして使えます。</p>
    <ul>
      <li>Tool Bar: 音声入力/検索・置換/共有の起点</li>
      <li>Edit Panel: 行/ブロック選択やカーソル移動を補助</li>
      <li>Search Panel: テキスト検索・置換</li>
      <li>Snapshot Panel: 履歴保存と復元</li>
    </ul>
    <div class="dialog-footer"><button id="btnCloseHelp" type="button">Close</button></div>
  </dialog>

  <div id="updateToast" class="toast hidden">
    <span>更新できます</span>
    <button id="btnUpdateApp" type="button">更新</button>
    <button id="btnUpdateLater" type="button">後で</button>
  </div>

  <script src="./app.js"></script>
</body>
</html>
